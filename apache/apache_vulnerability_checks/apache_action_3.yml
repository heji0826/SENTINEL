- set_fact:
    diag: "{{ { '항목': '링크 사용 금지 조치', 'id': 3, '조치방안': '1. 심볼릭 링크 사용 제한, 2. Alias 사용 제한' } }}"

- name: 심볼릭 링크 사용 제한 확인
  shell: cat /etc/httpd/conf/httpd.conf | grep 'Options Indexes FollowSymLinks'
  register: SymLinks_httpd
  ignore_errors: true

- set_fact:
    weak_symlinks: |
      {% if SymLinks_httpd.stdout.strip() | regex_search('Options Indexes FollowSymLinks') %}
        true
      {% else %}
        false
      {% endif %}

# 취약한 경우 심볼릭 링크 사용 제한 설정 추가 및 Apache 재시작
- block:
    - name: 심볼릭 링크에서 Indexes 제거
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^ *Options +Indexes +FollowSymLinks'
        line: 'Options FollowSymLinks'  
      register: SymLinks_action

    - name: Apache 재시작
      service:
        name: httpd
        state: restarted
      when: SymLinks_action.changed

- name: Alias 사용 제한 확인
  shell: cat /etc/httpd/conf/httpd.conf | grep '^ *Alias'
  register: aliases_httpd
  ignore_errors: true

- set_fact:
    weak_aliases: >
      {% if aliases_httpd.stdout.strip() | regex_search('^ *Alias') %}
        true   
      {% else %}
        false  
      {% endif %}
- debug:
    var: weak_aliases

- block:
    - name: Alias 사용 제한 설정 추가
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^ *Alias'
        line: '# Alias'
      register: aliases_action

    - name: Apache 재시작
      service:
        name: httpd
        state: restarted
      when: aliases_action.changed

