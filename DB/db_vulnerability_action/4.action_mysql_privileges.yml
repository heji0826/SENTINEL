# Header: Set diagnostic information
- set_fact:
    diag: "{{ {'항목': 'DB 사용자 계정 정보 테이블 접근 권한', 'id': 4, '조치방안': '일반 사용자 계정의 권한 제거'} }}"

# 1. select_priv가 Y인 사용자 조회
- name: Get users with select_priv='Y' excluding root
  mysql_query:
    login_user: root
    login_password: "rockylinux"
    query: "SELECT user, host FROM mysql.user WHERE select_priv = 'Y' AND user != 'root';"
  register: users_with_select_priv

# 2. 각 사용자에 대해 select_priv를 N으로 설정
- name: Revoke SELECT privileges from users
  mysql_user:
    login_user: root
    login_password: "rockylinux"
    name: "{{ item.0.user }}"  # 사용자명
    host: "{{ item.0.host }}"  # 호스트명
    priv: "*.*:SELECT"
    state: absent
  loop: "{{ users_with_select_priv.query_result | flatten }}"  # 리스트 평탄화
  register: revoke_privileges

# 3. 각 사용자의 select_priv 상태를 확인하여 취약성을 결정
- name: Check select_priv status for users after revocation
  mysql_query:
    login_user: root
    login_password: "rockylinux"
    query: "SELECT user, host, select_priv FROM mysql.user WHERE user != 'root';"
  register: updated_users_with_select_priv

# 4. Result block for when privileges were revoked
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: updated_users_with_select_priv.query_result | selectattr(0, 'equalto', 'Y') | length > 0

# Result block for when no privileges were revoked
- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: updated_users_with_select_priv.query_result | selectattr(0, 'equalto', 'Y') | length == 0

# 5. 최종 결과 출력
- name: 최종 결과 출력
  debug:
    var: result
