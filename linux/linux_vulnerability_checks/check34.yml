- set_fact:
    diag: "{{ {'항목': 'DNS ZoneTransfer 설정', 'id': 34, '조치방안': ' 특정 서버 Zone Transfer 지정, 특정 도메인의 Zone에 대해서 제한할 경우 다음과 같이 설정 zone \"xxx.co.kr\" {Type master; File \"db.xxx.co.kr\"; allow-transfer{10.10.10.111; 10.10.10.112;}; } '} }}"

- name: zone transfer 파일 확인
  shell: "sudo cat /etc/named.conf"
  register: zonetransfer_check1
  ignore_errors: true 


- name: zone transfer 설정 확인
  shell: "sudo cat /etc/named.conf | grep 'allow-transfer'"
  register: zonetransfer_check2
  ignore_errors: true 

- name: DNS 취약점 설정 업데이트
  set_fact:
    weak_dns: false  # allow-transfer 설정이 존재하면 양호
  when: zonetransfer_check2.stdout | length > 0

- name: DNS 취약점 설정 업데이트 2
  set_fact:
    weak_dns: false  
  when: zonetransfer_check1.rc != 0  

- name: DNS 취약점 설정 업데이트 2
  set_fact:
    weak_dns: true  
  when: zonetransfer_check2.rc != 0


- block:
    - debug:
        msg: "DNS ZoneTransfer 설정 취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: weak_dns  

- block:
    - debug:
        msg: "DNS ZoneTransfer 설정 양호" 
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: not weak_dns 

