# header
- set_fact:
    diag: "{{ {'항목': '웹 프로세스 권한 제한', 'id': 6, '조치방안': 'apache 데몬 user/group 일반계정으로 변경'} }}"

# httpd.conf 파일에서 'Group root'가 설정되어 있는지 확인
- name: Check if Group root is set in httpd.conf
  shell: "grep -E '^Group root' /etc/httpd/conf/httpd.conf"
  register: group_root_check  # 결과를 'group_root_check'에 저장
  ignore_errors: yes  # 명령어 실행 실패 시 무시

# httpd.conf 파일에서 'User root'가 설정되어 있는지 확인
- name: Check if User root is set in httpd.conf
  shell: "grep -E '^User root' /etc/httpd/conf/httpd.conf"
  register: user_root_check  # 결과를 'user_root_check'에 저장
  ignore_errors: yes  # 명령어 실행 실패 시 무시

# 'Group root'가 발견되면 'Group apache'로 교체
- name: Replace Group root with Group apache
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: '^Group root'  # 'Group root'로 시작하는 줄을 찾음
    line: 'Group apache'  # 'Group apache'로 교체
    state: present  # 해당 줄이 파일에 존재하도록 함
  register: group_change  # 이 작업의 결과를 저장
  when: group_root_check.rc == 0  # 'Group root'가 발견된 경우에만 실행

# 'User root'가 발견되면 'User apache'로 교체
- name: Replace User root with User apache
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: '^User root'  # 'User root'로 시작하는 줄을 찾음
    line: 'User apache'  # 'User apache'로 교체
    state: present  # 해당 줄이 파일에 존재하도록 함
  register: user_change  # 이 작업의 결과를 저장
  when: user_root_check.rc == 0  # 'User root'가 발견된 경우에만 실행

# 설정이 변경되었을 경우 Apache 서비스를 재시작
- name: Restart Apache service if changes were made
  service:
    name: httpd  # Apache 서비스 이름 지정
    state: restarted  # 서비스를 재시작
  when: group_change.changed or user_change.changed  # 변경이 발생했을 때만 재시작

# 사용자 및 그룹에 대한 업데이트된 Apache 설정을 출력
- name: Display updated Apache config for User and Group
  shell: "grep -E '^User|^Group' /etc/httpd/conf/httpd.conf"  # 현재 사용자 및 그룹 설정 확인
  register: apache_config_check  # 결과를 'apache_config_check'에 저장

# 업데이트된 Apache 설정 출력
- name: Show updated Apache config
  debug:
    msg: "{{ apache_config_check.stdout_lines }}"  # 이전 명령의 결과 출력

# result
- block:
    - debug:
        msg: "취약"  # 설정이 취약하다고 표시
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: 
    - (group_root_check.rc == 0 or user_root_check.rc == 0)  # 'Group root' 또는 'User root'가 존재하는 경우
    - ('User apache' not in apache_config_check.stdout or 'Group apache' not in apache_config_check.stdout)  # 업데이트된 항목이 없을 경우 확인

# 양호한 경우 result 설정
- block:
    - debug:
        msg: "양호"  # 설정이 양호하다고 표시
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: 
    - (group_root_check.rc != 0 and user_root_check.rc != 0)  # 둘 다 발견되지 않았는지 확인
