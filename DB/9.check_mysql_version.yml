---
  - name: Check MySQL latest security patch version and update if necessary
    hosts: mysql_servers
    become: yes
    tasks:

      # header: 진단 항목을 설정합니다.
      - set_fact:
          diag: "{{ {'항목': '최신 보안 패치 적용', 'id': 9} }}"
          result: []

      - name: Get MySQL current version
        shell: "mysql -V | awk '{ print $5 }' | cut -d',' -f1"
        register: mysql_version
        ignore_errors: yes

      - name: Show MySQL version
        debug:
          var: mysql_version.stdout

      - name: Check if MySQL version is up-to-date
        shell: "yum info mysql-server | grep Version"
        register: mysql_available_version
        ignore_errors: yes

      - name: Show available MySQL version from repository
        debug:
          var: mysql_available_version.stdout

      - name: Compare installed version with latest version
        set_fact:
          mysql_update_required: "{{ mysql_version.stdout is version(mysql_available_version.stdout, '<') }}"

      # result: MySQL 버전이 최신이 아닐 경우 취약으로 표시
      - block:
          - debug:
              msg: "취약"
          - set_fact:
              result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True}] }}"
        when: mysql_update_required

      # result: MySQL이 최신일 경우 양호로 표시
      - block:
          - debug:
              msg: "양호"
          - set_fact:
              result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False}] }}"
        when: not mysql_update_required
      
      # 최종 결과 출력
      - name: 결과 출력
        debug:
          var: result
