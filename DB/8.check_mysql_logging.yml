---
  - name: Check MySQL log settings (General log and Slow log)
    hosts: mysql_servers
    become: yes
    tasks:
      # header (진단 항목 설정)
      - set_fact:
          diag: "{{ {'항목': '로그 활성화', 'id': 8, '조치방안': 'General log, Slow log 설정'} }}"

      # 결과 초기화
      - set_fact:
          result: []

      # General log 설정 확인
      - name: Check if General log is enabled
        mysql_query:
          login_user: root
          login_password: 'rockylinux'
          query: "SHOW VARIABLES LIKE 'general_log';"
        register: general_log_status

      # General log 상태 출력
      - name: Display General log status
        debug:
          var: general_log_status

      # General log 파일 경로 확인
      - name: Check General log file path
        mysql_query:
          login_user: root
          login_password: 'rockylinux'
          query: "SHOW VARIABLES LIKE 'general_log_file';"
        register: general_log_file

      # General log 파일 경로 출력
      - name: Display General log file path
        debug:
          var: general_log_file

      # Slow query log 설정 확인
      - name: Check if Slow query log is enabled
        mysql_query:
          login_user: root
          login_password: 'rockylinux'
          query: "SHOW VARIABLES LIKE 'slow_query_log';"
        register: slow_query_log_status

      # Slow query log 상태 출력
      - name: Display Slow query log status
        debug:
          var: slow_query_log_status

      # Slow query log 파일 경로 확인
      - name: Check Slow query log file path
        mysql_query:
          login_user: root
          login_password: 'rockylinux'
          query: "SHOW VARIABLES LIKE 'slow_query_log_file';"
        register: slow_query_log_file

      # Slow query log 파일 경로 출력
      - name: Display Slow query log file path
        debug:
          var: slow_query_log_file

      # Long query time 설정 확인
      - name: Check Long query time setting
        mysql_query:
          login_user: root
          login_password: 'rockylinux'
          query: "SHOW VARIABLES LIKE 'long_query_time';"
        register: long_query_time

      # Long query time 설정 출력
      - name: Display Long query time setting
        debug:
          var: long_query_time

      # result (취약한 경우)
      - block:
          - debug:
              msg: "취약"
          - set_fact:
              result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
        when: general_log_status.query_result[0][0].Value == "OFF" or slow_query_log_status.query_result[0][0].Value == "OFF"

      # result (양호한 경우)
      - block:
          - debug:
              msg: "양호"
          - set_fact:
              result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
        when: general_log_status.query_result[0][0].Value == "ON" and slow_query_log_status.query_result[0][0].Value == "ON"

      # 최종 결과 출력
      - name: 결과 출력
        debug:
          var: result
