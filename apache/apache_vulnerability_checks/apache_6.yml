# header
- set_fact:
    diag: "{{ {'항목': '웹 프로세스 권한 제한', 'id': 6, '조치방안': 'apache 데몬 user/group 일반계정으로 변경'} }}"

# body

# 1. Check Apache process
- name: Check Apache process
  shell: "ps -ef | grep apache | grep -v grep"
  register: apache_process
  ignore_errors: yes

- name: Display Apache process info
  debug:
    msg: "{{ apache_process.stdout_lines }}"

# 2. Check if Apache is running with root privileges
- name: Check if Apache is running with root privileges
  shell: "ps -eo user,comm | grep apache | grep -v grep"
  register: process_privileges
  ignore_errors: yes

# 3. Set weak variable based on Apache privileges
- set_fact:
    weak: "{{ 'root' in process_privileges.stdout }}"

- debug:
    msg: "Weak variable value: {{ weak }}"

# 4. Final result
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: weak

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: not weak
