- name: Set diagnostic header for Sendmail
  set_fact:
    diag: "{{ {'항목': 'Sendmail 릴레이 제한 설정', 'id': 31} }}"

- name: Check if Sendmail is installed
  command: which sendmail
  register: sendmail_check
  ignore_errors: yes

- name: Check if Sendmail is running
  systemd:
    name: sendmail
    state: started
  when: sendmail_check.stdout != ""

- name: Check Sendmail relay restrictions
  command: grep -Ei 'relayclients|SMART_HOST|LOCAL_CONFIG' /etc/mail/sendmail.mc
  register: sendmail_relay_check
  failed_when: false
  when: sendmail_check.stdout != ""

- name: Display Sendmail relay restrictions
  debug:
    msg: "Sendmail relay restrictions: {{ sendmail_relay_check.stdout }}"
  when: sendmail_relay_check is defined

- block:
    - debug:
        msg: "Sendmail 설정: 취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True}] }}"
  when: sendmail_relay_check.stdout == ""

- block:
    - debug:
        msg: "Sendmail 설정: 양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False}] }}"
  when: sendmail_relay_check.stdout != ""

- name: Set diagnostic header for Postfix
  set_fact:
    diag: "{{ {'항목': 'Postfix 릴레이 제한 설정', 'id': 2} }}"

- name: Check if Postfix is installed
  command: which postfix
  register: postfix_check
  ignore_errors: yes

- name: Check if Postfix is running
  systemd:
    name: postfix
    state: started
  when: postfix_check.stdout != ""

- name: Check Postfix relay restrictions
  command: grep -i 'smtpd_recipient_restrictions' /etc/postfix/main.cf
  register: postfix_relay_check
  when: postfix_check.stdout != ""

- name: Display Postfix relay restrictions
  debug:
    msg: "Postfix relay restrictions: {{ postfix_relay_check.stdout }}"
  when: postfix_relay_check is defined

- block:
    - debug:
        msg: "Postfix 설정: 취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True}] }}"
  when: postfix_relay_check.stdout == ""

- block:
    - debug:
        msg: "Postfix 설정: 양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False}] }}"
  when: postfix_relay_check.stdout != ""
