---
  - hosts: mysql_servers
    remote_user: rockylinux
    become: yes

    # Task to remove unnecessary MySQL accounts
    tasks:
      # Header: Set fact to define diagnostic information
      - set_fact:
          diag: "{{ {'항목': '취약한 패스워드 사용 제한', 'id': 2, '조치방안': '패스워드 복잡도 설정'} }}"

      - set_fact:
          result: []

      # 2. Set MySQL password validation policy
      - name: Set MySQL validate_password_policy to STRONG
        mysql_query:
          login_user: root
          login_password: "rockylinux"
          query: "SET GLOBAL validate_password_policy = 'STRONG';"

      - name: Set minimum password length to 8
        mysql_variables:
          variable: validate_password_length
          value: 8
          login_user: root
          login_password: "rockylinux"

      - name: Set other password validation requirements
        mysql_variables:
          variable: "{{ item.variable }}"
          value: "{{ item.value }}"
          login_user: root
          login_password: "rockylinux"
        loop:
          - { variable: 'validate_password_mixed_case_count', value: 1 }
          - { variable: 'validate_password_number_count', value: 1 }
          - { variable: 'validate_password_special_char_count', value: 1 }

      # Result: Check the validation policy application
      - name: Check password validation policy application
        set_fact:
          weak: false  # 기본값을 false로 설정

      - block:
          - debug:
              msg: "취약"
          - set_fact:
              result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
        when: weak

      - block:
          - debug:
              msg: "양호"
          - set_fact:
              result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
        when: not weak

      - name: 최종 결과 출력
        debug:
          var: result
