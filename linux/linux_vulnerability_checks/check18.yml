- set_fact:    
    diag: "{{ {'항목': '접속 IP 및 포트 제한', 'id': 18, '조치방안': '/etc/hosts.deny 파일 수정(vi /etc/hosts.deny, ALL deny 설정 ALL:ALL), 및 /etc/hosts.allow 파일 수정 (vi /etc/hosts.allow, 접속 허용 서비스 및 IP 설정 (예시) sshd : 192.168.0.148)'} }}"
    diag_ip: 
      { '항목': '접속 IP 제한', 'id': 18 }
    diag_port: 
      { '항목': '포트 제한', 'id': 18 }

- name: 접속을 허용할 특정 호스트에 대한 IP 주소 제한 설정 진단 초기화 
  set_fact:
    diag_ip: true

- name: 접속을 허용할 특정 호스트에 대한 포트 번호 제한 설정 진단 초기화 
  set_fact:
    diag_port: true

- name: 본인 IP 확인
  shell: "hostname -I | awk '{print $1}'"  # 첫 번째 IP 주소를 확인
  register: ipconfig
  ignore_errors: true 

- set_fact:
    my_ip: "{{ ipconfig.stdout.strip() }}"  # 본인 IP 저장

- name: 접근 허용 IP 적절성 확인 (hosts.deny)
  shell: "cat /etc/hosts.deny"
  register: deny_check
  ignore_errors: true 

- name: 접근 허용 IP 적절성 확인 (hosts.allow)
  shell: "cat /etc/hosts.allow"
  register: allow_check
  ignore_errors: true 

- name: 접근 금지 IP 설정 확인
  set_fact:
    diag_ip: false
    deny_check_status: "{{ 'ALL: ALL' in deny_check.stdout }}"
  when: deny_check.stdout is defined

- name: 접근 허용 IP 설정 확인
  set_fact:
    diag_ip: false
    allow_check_status: "{{ my_ip in allow_check.stdout }}"
  when: allow_check.stdout is defined

# 추가: firewalld 상태 확인
- name: firewalld에서 현재 설정된 방화벽 규칙 확인
  shell: "firewall-cmd --list-all"
  register: firewall_check
  ignore_errors: true

- name: 포트 제한 설정 여부 확인 
  set_fact:
    diag_port: true  
  when: "'ports:' in firewall_check.stdout and firewall_check.stdout.split('ports:')[1].strip() == ''"  # 포트 항목이 비어있을 때 취약

- name: iptables에서 현재 설정된 방화벽 규칙 확인
  shell: "iptables -nL"
  register: iptables_check
  ignore_errors: true

# IP 주소 및 포트 제한 확인
- name: IP 주소 제한 확인
  set_fact:
    diag_ip: false
  when: "'DROP' in iptables_check.stdout or 'REJECT' in iptables_check.stdout"  # IP가 차단되었을 때


#### 최종 결과 출력

- block:
    - debug:
        msg: "접속 IP 및 포트 제한 양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안 }] }}"
  when: not diag_ip and not diag_port 

- block:
    - debug:
        msg: "접속 IP 및 포트 제한 취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안 }] }}"
  when: diag_ip or diag_port 
