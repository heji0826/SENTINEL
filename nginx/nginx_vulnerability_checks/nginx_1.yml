- set_fact:
    diag: "{{ {'항목': '웹 서비스 영역의 분리 ', 'id': 1, '조치방안': '기본 디렉터리 위치 변경'} }}"

# nginx.conf 파일 존재 여부 확인
- name: nginx.conf 파일 존재 여부 확인
  stat:
    path: /etc/nginx/nginx.conf
  register: nginx_conf

# root 설정 확인
- name: root 설정 확인
  shell: cat /etc/nginx/nginx.conf | grep root
  register: root_check
  ignore_errors: true
  when: nginx_conf.stat.exists

# 경로 추출
- set_fact:
    document_root_path: >
      {% if root_check.stdout %}
        {% set match = root_check.stdout | regex_search('root +(.*);') %}
        {% if match %}
          {{ match[0] }}
        {% else %}
          "없음"
        {% endif %}
      {% else %}
        "없음"
      {% endif %}

# regex_search 결과 확인
- set_fact:
    regex_result: >
      {% if document_root_path.strip() | regex_search('/usr/share/nginx/html') %}
        true
      {% else %}
        false
      {% endif %}

# 최종 결과
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안 }] }}"
  when: regex_result | regex_search('true') is not none  # /usr/share/nginx/html이 포함된 경우

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안 }] }}"
  when: regex_result | regex_search('false') is not none  # /usr/share/nginx/html이 포함되지 않은 경우
