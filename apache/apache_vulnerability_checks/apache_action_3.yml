- set_fact:
    diag: "{{ { '항목': 'Apache 링크 사용 취약점 조치', 'id': 3, '조치방안': '1. 심볼릭 링크 사용 제한, 2. Alias 사용 제한' } }}"

- name: 심볼릭 링크 사용 제한 확인
  shell: cat /etc/httpd/conf/httpd.conf | grep 'Options Indexes FollowSymLinks'
  register: SymLinks_httpd
  ignore_errors: true

- set_fact:
    weak_symlinks: |
      {% if SymLinks_httpd.stdout.strip() | regex_search('Options Indexes FollowSymLinks') %}
        true
      {% else %}
        false
      {% endif %}

# 취약한 경우 심볼릭 링크 사용 제한 설정 추가 및 Apache 재시작
- block:
    - name: 심볼릭 링크에서 Indexes 제거
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^ *Options +Indexes +FollowSymLinks'
        line: 'Options FollowSymLinks'  # Indexes를 제거한 새로운 라인
      register: SymLinks_action

    - name: Apache 재시작
      service:
        name: httpd
        state: restarted
      when: SymLinks_action.changed

    # 설정 후 재검사: 다시 심볼릭 링크 사용 제한 확인
    - name: 심볼릭 링크 설정 확인 재실행
      shell: cat /etc/httpd/conf/httpd.conf | grep 'Options FollowSymLinks'
      register: SymLinks_httpd_after
      ignore_errors: true

    - set_fact:
        weak_symlinks: >
          {% if SymLinks_httpd_after.stdout.strip() | regex_search('Options FollowSymLinks') %}
            false
          {% else %}
            true
          {% endif %}

- name: Alias 사용 제한 확인
  shell: cat /etc/httpd/conf/httpd.conf | grep '^ *Alias'
  register: aliases_httpd
  ignore_errors: true

- set_fact:
    weak_aliases: >
      {% if aliases_httpd.stdout.strip() | regex_search('^ *Alias') %}
        true   # Alias가 있으면 취약
      {% else %}
        false  # Alias가 없으면 양호
      {% endif %}

# 취약한 경우 Alias 사용 제한 설정 추가 및 Apache 재시작
- block:
    - name: Alias 사용 제한 설정 추가
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^ *Alias'
        line: '# Alias'
      register: aliases_action

    - name: Apache 재시작
      service:
        name: httpd
        state: restarted
      when: aliases_action.changed


    - name: Alias 사용 제한 설정 확인 재실행
      shell: cat /etc/httpd/conf/httpd.conf | grep '^ *Alias'
      register: aliases_httpd_after
      ignore_errors: true

    # 설정 후 다시 평가
    - set_fact:
        weak_aliases: >
          {% if aliases_httpd_after.stdout.strip() | regex_search('^ *Alias') %}
            true
          {% else %}
            false
          {% endif %}

- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안 }] }}"
  when: (weak_symlinks | regex_search('false')) is none or (weak_aliases | regex_search('false')) is none


- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안 }] }}"
  when: (weak_symlinks | regex_search('false')) is not none and (weak_aliases | regex_search('false')) is not none
