- set_fact:
    diag: "{{ {'항목': '안전한 패스워드 암호화 알고리즘 사용', 'id': 7, '조치방안': 'SHA-256 이상의 해시 알고리즘 설정'} }}"

- set_fact:
    result: []

- name: Gather MySQL user accounts that are not using SHA-256
  mysql_query:
    login_user: root
    login_password: "rockylinux"
    query: "SELECT user, host, plugin FROM mysql.user WHERE plugin NOT IN ('sha256_password', 'caching_sha2_password');"
  register: users

- name: Debug MySQL user query result
  debug:
    var: users

- name: Change password hashing algorithm for users
  mysql_user:
    name: "{{ item.user }}"
    host: "{{ item.host }}"
    login_user: root
    login_password: "rockylinux"
    password: "Test123!@#"
    plugin: sha256_password
  loop: "{{ users.results }}"
  when: users.results is defined and users.results | length > 0
  register: change_results

- name: Verify if any passwords were changed
  set_fact:
    password_changed: "{{ change_results is defined and change_results.changed | default(false) }}"

- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: users.results is defined and users.results | length > 0

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: users.results is not defined or users.results | length == 0

- name: 결과 출력
  debug:
    var: result
