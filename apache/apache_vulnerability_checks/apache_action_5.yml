# header
- set_fact:
    diag: "{{ {'항목': '디렉터리 리스팅 제거', 'id': 5, '조치방안': 'Options Indexes FollowSymLinks 주석처리'} }}"

- name: Ensure /etc/httpd/conf/httpd.conf exists
  stat:
    path: /etc/httpd/conf/httpd.conf
  register: httpd_conf
  become: true

- name: Search for "Indexes" option in httpd.conf
  shell: grep -E "^\s*Options.*Indexes" /etc/httpd/conf/httpd.conf
  register: indexes_option
  failed_when: false
  changed_when: false
  become: true

- name: Comment out the "Indexes" option if present
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: '^(\s*Options.*Indexes.*)$'
    line: '# \1'
    backrefs: yes
  when: indexes_option.stdout != ""
  notify:
    - Restart Apache
  become: true

# result
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: indexes_option.stdout != ""

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: indexes_option.stdout == ""
