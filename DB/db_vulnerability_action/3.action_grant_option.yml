# Header
- set_fact:
    diag: "{{ {'항목': '타 사용자에 권한 부여 옵션 제한', 'id': 3, '조치방안': '불필요한 grant_priv 권한 제거'} }}"

# 1. MySQL에서 grant_priv 확인
- name: Check grant_priv for all users
  mysql_query:
    login_user: root
    login_password: "rockylinux"
    query: "SELECT user, host FROM mysql.user WHERE grant_priv = 'Y';"
  register: grants_check

# 2. GRANT OPTION 회수 (root 제외)
- name: Revoke GRANT OPTION from users except root
  mysql_user:
    login_user: root
    login_password: "rockylinux"
    name: "{{ item.user }}"  # 사용자명
    host: "{{ item.host }}"   # 호스트명
    priv: "*.*:ALL,GRANT"
    state: present
    append_privs: no
  loop: "{{ grants_check.query_result[0] }}"  # 첫 번째 리스트에서 반복
  when: item.user != 'root'  # root 제외
  register: revoke_result

# 3. 결과 검증 및 결과에 따른 출력
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: revoke_result.changed

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: revoke_result is not changed and grants_check.query_result[0] | selectattr('user', 'equalto', 'root')

# 4. 최종 결과 출력
- name: 최종 결과 출력
  debug:
    var: result
