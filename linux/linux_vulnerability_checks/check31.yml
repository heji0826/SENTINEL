- set_fact:
    diag: "{{ {'항목': '스팸 메일 릴레이 제한 설정', 'id': 31, '조치방안': '릴레이 접근 제한 설정'} }}"

- name: Check if Sendmail is installed
  command: which sendmail
  register: sendmail_check
  ignore_errors: yes

- name: Check Sendmail relay restrictions
  command: grep -Ei 'relayclients|SMART_HOST|LOCAL_CONFIG' /etc/mail/sendmail.mc
  register: sendmail_relay_check
  failed_when: false
  when: sendmail_check.stdout != ""

- name: Check if Postfix is installed
  command: which postfix
  register: postfix_check
  ignore_errors: yes

- name: Check Postfix relay restrictions
  command: grep -i 'smtpd_recipient_restrictions' /etc/postfix/main.cf
  register: postfix_relay_check
  when: postfix_check.stdout != ""

- name: Evaluate if either Sendmail or Postfix is vulnerable
  set_fact:
    is_vulnerable: >
      {{
        (sendmail_relay_check is defined and sendmail_relay_check.stdout | default('') == '') or
        (postfix_relay_check is defined and postfix_relay_check.stdout | default('') == '')
      }}

- name: Update result based on evaluation
  set_fact:
    result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': is_vulnerable, '조치방안': diag.조치방안}] }}"
