# header
- set_fact:
    diag: "{{ {'항목': 'cron 파일 소유자 및 권한 설정', 'id': 19}} }"

# 1. Check for cron.allow file
- name: Check if cron.allow file exists
  stat:
    path: /etc/cron.allow
  register: cron_allow

# 2. Check permissions of cron.allow file if it exists
- name: Check permissions of cron.allow
  stat:
    path: /etc/cron.allow
  register: cron_allow_stats
  when: cron_allow.stat.exists

# 3. Check permissions of cron.deny file
- name: Check permissions of cron.deny
  stat:
    path: /etc/cron.deny
  register: cron_deny_stats

# 4. Check ownership and permissions
- name: Determine if cron.allow or cron.deny is compliant
  set_fact:
    weak: >
      (cron_allow.stat.exists and 
      (cron_allow_stats.stat.pw_name != 'root' or cron_allow_stats.stat.mode | int(base=8) > 0o640)) or
      (!cron_allow.stat.exists and 
      (cron_deny_stats.stat.pw_name != 'root' or cron_deny_stats.stat.mode | int(base=8) > 0o640))

# 5. Final result
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True}] }}"
  when: weak

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False}] }}"
  when: not weak

# 6. Display final result
- debug:
    var: result
