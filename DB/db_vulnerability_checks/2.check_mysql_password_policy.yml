# 헤더
- set_fact:
    diag: "{{ {'항목': '취약한 패스워드 사용 제한', 'id': 2, '조치방안': '패스워드 복잡도 설정'} }}"

# 결과 초기화
- set_fact:
    result: []

- name: Check MySQL validate_password_policy
  mysql_query:
    query: "SHOW VARIABLES LIKE 'validate_password_policy';"
    login_user: root
    login_password: 'rockylinux'
  register: password_policy

- name: Debug password policy query result
  debug:
    var: password_policy

- name: Check MySQL minimum password length
  mysql_query:
    query: "SHOW VARIABLES LIKE 'validate_password_length';"
    login_user: root
    login_password: 'rockylinux'
  register: password_length

- name: Debug password length query result
  debug:
    var: password_length

- name: Check validate_password_mixed_case_count
  mysql_query:
    query: "SHOW VARIABLES LIKE 'validate_password_mixed_case_count';"
    login_user: root
    login_password: 'rockylinux'
  register: mixed_case_count

- name: Debug mixed case count query result
  debug:
    var: mixed_case_count

- name: Check validate_password_number_count
  mysql_query:
    query: "SHOW VARIABLES LIKE 'validate_password_number_count';"
    login_user: root
    login_password: 'rockylinux'
  register: number_count

- name: Debug number count query result
  debug:
    var: number_count

- name: Check validate_password_special_char_count
  mysql_query:
    query: "SHOW VARIABLES LIKE 'validate_password_special_char_count';"
    login_user: root
    login_password: 'rockylinux'
  register: special_char_count

- name: Debug special char count query result
  debug:
    var: special_char_count

# 결과 처리
- set_fact:
    weak: false

# 취약성 체크
- set_fact:
    weak: true
  when: 
    - password_policy.query_result[0][0].Value | lower != 'strong' 
    - password_length.query_result[0][0].Value | int < 8 
    - mixed_case_count.query_result[0][0].Value | int < 1 
    - number_count.query_result[0][0].Value | int < 1 
    - special_char_count.query_result[0][0].Value | int < 1 

# 결과 추가
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: weak

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: not weak

- name: 최종 결과 출력
  debug:
    var: result
