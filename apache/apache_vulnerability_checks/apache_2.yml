# 진단 항목 정보 설정
- set_fact:
    diag: "{{ {'항목': '불필요한 파일 제거', 'id': 2, '조치방안': '매뉴얼 디렉터리 삭제'} }}"

# 매뉴얼 파일 존재 여부 확인
- name: manual 파일 존재 여부 확인
  stat:
    path: /etc/httpd/conf/manual
  register: manual_file

# 매뉴얼 파일 취약점 판단
- set_fact:
    weak_manual_file: >
      {% if manual_file.stat.exists %}
        true
      {% else %}
        false
      {% endif %}

# 매뉴얼 디렉터리 존재 여부 확인
- name: 매뉴얼 디렉터리 존재 여부 출력
  shell: cat /etc/httpd/conf/httpd.conf | grep manual
  register: grep_result
  ignore_errors: true  



# 매뉴얼 디렉터리 취약점 판단
- set_fact:
    weak_manual_dir: >
      {% if grep_result.stdout %}
          {% if grep_result.stdout | regex_search('# *manual') %}
              false  
          {% else %}
              true  
          {% endif %}
      {% else %}
          false  
      {% endif %}


# 최종 결과
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안 }] }}"
  when:  (weak_manual_dir | regex_search('false')) is none or (weak_manual_file | regex_search('false')) is none

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안 }] }}"
  when: (weak_manual_dir | regex_search('false')) is not none and (weak_manual_file | regex_search('false')) is not none
