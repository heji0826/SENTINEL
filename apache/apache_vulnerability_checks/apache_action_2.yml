- set_fact:
    diag: "{{ { '항목': '불필요한 파일 제거 조치', 'id': 2, '조치방안': '1. 매뉴얼 디렉터리 제거, 2. 매뉴얼 파일 주석 처리' } }}"

# 매뉴얼 디렉터리 확인
- name: 매뉴얼 디렉터리 존재 여부 확인
  shell: if [ -d /etc/httpd/conf/manual ]; then echo 'exists'; fi
  register: manual_dir_check
  ignore_errors: true

# 매뉴얼 파일 설정 확인
- name: 매뉴얼 파일 설정 확인
  shell: cat /etc/httpd/conf/httpd.conf | grep '^ *manual'
  register: manual_file_check
  ignore_errors: true

# 매뉴얼 디렉터리 취약 여부 판단
- set_fact:
    weak_manual_dir: >
      {% if manual_dir_check.stdout.strip() == 'exists' %}
        true   # 디렉터리가 존재하면 취약
      {% else %}
        false  # 디렉터리가 없으면 양호
      {% endif %}

# 매뉴얼 파일 취약 여부 판단
- set_fact:
    weak_manual_file: >
      {% if manual_file_check.stdout.strip() | regex_search('^ *manual') %}
        true   # 매뉴얼 설정이 존재하면 취약
      {% else %}
        false  # 매뉴얼 설정이 없으면 양호
      {% endif %}

# 취약한 경우 매뉴얼 디렉터리 제거 및 Apache 재시작
- block:
    - name: 매뉴얼 디렉터리 제거
      shell: rm -rf /etc/httpd/conf/manual
      register: manual_dir_action
      ignore_errors: true  # 디렉터리가 없을 경우 오류 무시

    - name: Apache 재시작 (디렉터리 제거 후)
      service:
        name: httpd
        state: restarted
      when: manual_dir_action.changed

# 취약한 경우 매뉴얼 파일 주석 처리 및 Apache 재시작
- block:
    - name: 매뉴얼 파일 주석 처리
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^( *manual.*)'  
        line: '# manual'  # 주석 처리
      register: manual_file_action

    - name: Apache 재시작
      service:
        name: httpd
        state: restarted
      when: manual_file_action.changed

# 매뉴얼 디렉터리 제거 후 다시 확인
- name: 매뉴얼 디렉터리 확인 재실행
  shell: if [ -d /etc/httpd/conf/manual ]; then echo 'exists'; fi
  register: manual_dir_check_after
  ignore_errors: true

# 매뉴얼 파일 설정 확인 재실행
- name: 매뉴얼 파일 설정 확인 재실행
  shell: cat /etc/httpd/conf/httpd.conf | grep '^ *manual'
  register: manual_file_check_after
  ignore_errors: true

# 매뉴얼 디렉터리 상태 재평가
- set_fact:
    weak_manual_dir: >
      {% if manual_dir_check_after.stdout.strip() == 'exists' %}
        true
      {% else %}
        false
      {% endif %}

# 매뉴얼 파일 상태 재평가
- set_fact:
    weak_manual_file: >
      {% if manual_file_check_after.stdout.strip() | regex_search('^ *manual') %}
        true
      {% else %}
        false
      {% endif %}

- debug: 
    var: weak_manual_dir

- debug: 
    var: weak_manual_file
