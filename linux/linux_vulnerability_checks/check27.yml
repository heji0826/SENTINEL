# header
- set_fact:
    diag: "{{ {'항목': 'rpc 서비스 확인', 'id': 27} }}"

# body
- name: Check if xinetd is installed
  command: "ls /etc/xinetd.d/rstatd"
  register: xinetd_check
  ignore_errors: yes

- block:
    # 취약 변수 기본 값: 양호 
    - set_fact:
        weak_rstatd: "{{ weak_rstatd | default(false) }}"
        weak_rpcbind: "{{ weak_rpcbind | default(false) }}"

    - name: Check rstatd configuration
      shell: "cat /etc/xinetd.d/rstatd"
      register: rstatd_conf
      when: xinetd_check.rc == 0
      ignore_errors: yes

    - name: Set weak variable based on rstatd configuration
      set_fact:
        weak: "{{ 'disabled=yes' not in rstatd_conf.stdout }}"
      when: xinetd_check.rc == 0

    - set_fact:
        weak_rstatd: true
      when: weak is defined and weak 

    - set_fact:
        weak_rstatd: false
      when: weak is defined and not weak

    - name: Check if rpcbind is active
      command: "systemctl is-active rpcbind"
      register: rpcbind_status
      when: xinetd_check.rc != 0
      failed_when: false

    - set_fact:
        weak_rpcbind: true
      when: rpcbind_status.stdout == "active"

    - set_fact:
        weak_rpcbind: false
      when: rpcbind_status.stdout != "active"

    - block:
        - debug:
            msg: "취약"
        - set_fact:
            result: "{{ result | default([]) + [{'id': diag.id, '제목': diag.항목, '취약': True}] }}"
      when: weak_rpcbind or weak_rstatd

    - block:
        - debug:
            msg: "양호"
        - set_fact:
            result: "{{ result | default([]) + [{'id': diag.id, '제목': diag.항목, '취약': False}] }}"
      when: not weak_rpcbind and not weak_rstatd
