# Header
- set_fact:
    diag: "{{ {'항목': '타 사용자에 권한 부여 옵션 제한', 'id': 3, '조치방안': '불필요한 grant_priv 권한 제거'} }}"

- name: Change password for 'test' user to satisfy password policy
  mysql_user:
    name: 'test'
    host: 'localhost'
    password: "Test123!@#"
    login_user: root
    login_password: "rockylinux"

- name: Revoke GRANT OPTION from users
  mysql_user:
    login_user: root
    login_password: "rockylinux"
    name: "{{ item.name }}"
    host: "{{ item.host }}"
    priv: "*.*:ALL,GRANT"
    state: present
    append_privs: no
  loop:
    - { name: 'test', host: 'localhost' }
  register: revoke_result

- name: Verify revoked privileges
  debug:
    var: revoke_result

# Result block based on the outcome
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: revoke_result.changed

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: not revoke_result.changed

- name: 최종 결과 출력
  debug:
    var: result
