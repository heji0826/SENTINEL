# header
- set_fact:
    diag: "{{ {'항목': '웹 프로세스 권한 제한', 'id': 6, '조치방안': 'apache 데몬 user/group 일반계정으로 변경'} }}"

- name: Check Apache process
  shell: "ps -ef | grep httpd | grep -v grep"  # httpd로 변경
  register: apache_process

- name: Display Apache process info
  debug:
    msg: "{{ apache_process.stdout_lines }}"

- name: Check if Apache is running with root privileges
  shell: "ps -eo user,comm | grep httpd | grep -v grep"  # httpd로 변경
  register: process_privileges

- name: Verify Apache user privileges
  debug:
    msg: "{{ process_privileges.stdout_lines }}"

- name: Fail if Apache is running with root privileges
  fail:
    msg: "Apache is running with root privileges, which is a security risk."
  when: "'root' in process_privileges.stdout"

- name: Ensure Apache is running under a non-root user
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: '^User '
    line: 'User apache'  # Apache 소유자 변경
    state: present

- name: Ensure Apache is running under a non-root group
  lineinfile:
    path: /etc/httpd/conf/httpd.conf
    regexp: '^Group '
    line: 'Group apache'  # Apache 그룹 변경
    state: present

- name: Restart Apache service to apply changes
  service:
    name: httpd
    state: restarted
  when: "'root' in process_privileges.stdout"

- name: Confirm Apache is running under non-root user
  shell: "ps -eo user,comm | grep httpd | grep -v grep"
  register: updated_privileges

- name: Display updated Apache user privileges
  debug:
    msg: "{{ updated_privileges.stdout_lines }}"

# result
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: "'root' in process_privileges.stdout"

- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: "'root' not in process_privileges.stdout"
