# Header: Set diagnostic information
- set_fact:
    diag: "{{ {'항목': 'DB 사용자 계정 정보 테이블 접근 권한', 'id': 4, '조치방안': '일반 사용자 계정의 권한 제거'} }}"

# 1. select_priv가 Y인 사용자 조회
- name: Get users with select_priv='Y' excluding root
  mysql_query:
    login_user: root
    login_password: "rockylinux"
    query: "SELECT user, host FROM mysql.user WHERE select_priv = 'Y' AND user != 'root';"
  register: users_with_select_priv

# 2. 각 사용자에 대해 select_priv를 N으로 설정
- name: Revoke SELECT privileges from users
  mysql_user:
    login_user: root
    login_password: "rockylinux"
    name: "{{ item.0 }}"  # 사용자명
    host: "{{ item.1 }}"  # 호스트명
    priv: "*.*:SELECT"
    state: absent
  loop: "{{ users_with_select_priv.query_result }}"  # 여기서 query_result의 각 아이템을 순회
  register: revoke_privileges

# 3. Verify revoked privileges
- name: Debug revoked privileges
  debug:
    var: revoke_privileges

# Result block for when privileges were revoked
- block:
    - debug:
        msg: "취약"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': True, '조치방안': diag.조치방안}] }}"
  when: revoke_privileges.changed

# Result block for when no privileges were revoked
- block:
    - debug:
        msg: "양호"
    - set_fact:
        result: "{{ result + [{'id': diag.id, '제목': diag.항목, '취약': False, '조치방안': diag.조치방안}] }}"
  when: not revoke_privileges.changed

# 4. 최종 결과 출력
- name: 최종 결과 출력
  debug:
    var: result
